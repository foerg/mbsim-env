#! /bin/sh
# Unix sh variant of mbsimxml (mbsimxml.in)
# If editing this file, also edit the file mbsimxml.bat.in!

# variables from build configuration
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=${exec_prefix}/bin
MBXMLUTILSSCHEMA=@MBXMLUTILSSCHEMA@
MBXMLUTILSBIN=@MBXMLUTILSBINDIR@

# try relative path (rel to this file) if build configuration dose not work
INSTDIR=$(dirname $(dirname $0))
test -x $bindir/mbsimflatxml || bindir=$INSTDIR/bin
test -e $MBXMLUTILSSCHEMA/http___mbsim_berlios_de_MBSimXML/mbsimxml.xsd || MBXMLUTILSSCHEMA=$INSTDIR/share/mbxmlutils/schema
test -x $MBXMLUTILSBIN/mbxmlutilspp || MBXMLUTILSBIN=$INSTDIR/bin

# get environment variables (for none default intallation; overwrites all others)
test $MBSIMBINDIR && bindir=$MBSIMBINDIR
test $MBXMLUTILSSCHEMADIR && MBXMLUTILSSCHEMA=$MBXMLUTILSSCHEMADIR
test $MBXMLUTILSBINDIR && MBXMLUTILSBIN=$MBXMLUTILSBINDIR

# help
if [ $# -eq 0 -o "_$1" = "_-h" -o "_$1" = "_--help" ]; then
  echo "Usage: mbsimxml [--onlypreprocess|--donotintegrate|--stopafterfirststep]"
  echo "                [--mbsimparam <mbsimparameterfile>] <mbsimfile>"
  echo "                [--intparam <integratorparameterfile>] <integratorfile>"
  echo ""
  echo "Copyright (C) 2004-2009 MBSim Development Team"
  echo "This is free software; see the source for copying conditions. There is NO"
  echo "warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
  echo ""
  echo "Licensed under the GNU Lesser General Public License (LGPL)"
  echo ""
  echo "--onlypreprocess     Stop after the preprocessing stage"
  echo "--donotintegrate     Stop after the initialization stage, do not integrate"
  echo "--stopafterfirststep Stop after outputting the first step (usually at t=0)"
  echo "                     This generates a HDF5 output file with only one time serie"
  echo "--mbsimparam <file>  Use <file> as parameter file for mbsim xml file"
  echo "<mbsimfile>          Use <mbsimfile> as mbsim xml file"
  echo "--intparam <file>    Use <file> as parameter file for mbsim integrator xml file"
  echo "<integratorfile>     Use <integratorfile> as mbsim integrator xml file"
  exit
fi

# parameters
ONLYPP="false"
if [ "_$1" = "_--onlypreprocess" ]; then
  ONLYPP="true"
  shift
fi
NOINT="false"
if [ "_$1" = "_--donotintegrate" ]; then
  NOINT="true"
  shift
fi
if [ "_$1" = "_--stopafterfirststep" ]; then
  ONLY1OUT="true"
  shift
fi
if [ "_$1" = "_--mbsimparam" ]; then
  PARAM=$2
  shift
  shift
else
  PARAM=none
fi
MBSIM=$1
PPMBSIM=.pp.$(basename $MBSIM)
shift
if [ "_$1" = "_--intparam" ]; then
  PARAMINT=$2
  shift
  shift
else
  PARAMINT=none
fi
MBSIMINT=$1
PPMBSIMINT=.pp.$(basename $MBSIMINT)

rm -f $PPMBSIM $PPMBSIMINT

$MBXMLUTILSBIN/mbxmlutilspp $PARAM $MBSIM $MBXMLUTILSSCHEMA/http___mbsim_berlios_de_MBSimXML/mbsimxml.xsd $PARAMINT $MBSIMINT $MBXMLUTILSSCHEMA/http___mbsim_berlios_de_MBSim/mbsimintegrator.xsd || exit 1

if [ $ONLYPP = "false" ]; then
  if [ $NOINT = "true" ]; then
    $bindir/mbsimflatxml --donotintegrate $PPMBSIM $PPMBSIMINT || exit 1
  else
    if [ $ONLY1OUT = "true" ]; then
      $bindir/mbsimflatxml --stopafterfirststep $PPMBSIM $PPMBSIMINT || exit 1
    else
      $bindir/mbsimflatxml $PPMBSIM $PPMBSIMINT || exit 1
    fi
  fi
fi
